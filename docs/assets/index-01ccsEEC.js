(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))h(i);new MutationObserver(i=>{for(const f of i)if(f.type==="childList")for(const b of f.addedNodes)b.tagName==="LINK"&&b.rel==="modulepreload"&&h(b)}).observe(document,{childList:!0,subtree:!0});function a(i){const f={};return i.integrity&&(f.integrity=i.integrity),i.referrerPolicy&&(f.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?f.credentials="include":i.crossOrigin==="anonymous"?f.credentials="omit":f.credentials="same-origin",f}function h(i){if(i.ep)return;i.ep=!0;const f=a(i);fetch(i.href,f)}})();class U{canvas;alpha;desync;context;constructor(r,a){this.canvas=r??document.createElement("canvas"),this.alpha=!a?.noAlpha,this.desync=!!a?.desync,this.context=this.canvas.getContext("2d",{alpha:this.alpha,desynchronized:this.desync})}}const P=e=>Math.PI*e/180;var d;(e=>{function r(c,l){console.log(`${l??""}${l?" ~ ":""}vec(${c.length}) ${JSON.stringify(c)}`)}e.log=r;function a(c,l){return c.map((n,o)=>n+l[o])}e.vAdd=a;function h(c,l){return c.map((n,o)=>n-l[o])}e.vSub=h;function i(c,l){let n=0;for(let o=0;o<c.length;o++)n+=c[o]*l[o];return n}e.dot=i;function f(c,l){const[n,o,s]=c,[u,m,v]=l;return[o*v-s*m,s*u-n*v,n*m-o*u]}e.cross=f;function b(c,l){return c.map(n=>n+l)}e.add=b;function $(c,l){return b(c,-l)}e.sub=$;function A(c,l){return c.map(n=>n*l)}e.mul=A;function y(c,l){return A(c,1/l)}e.div=y;function C(c){return i(c,c)**.5}e.norm=C;function T(c){return y(c,C(c))}e.unit=T;function M(c){return c.concat(1)}e.homo=M;function N(c){return y(c.slice(0,-1),c.at(-1))}e.unhomo=N})(d||(d={}));var p;(e=>{function r(n,o){console.log(`${o??""}${o?" ~ ":""}mat(${n.length}x${n.length})
[${n.map(s=>JSON.stringify(s)).join(`
 `)}]`)}e.log=r;function a(n){return[...Array(n)].map(()=>Array(n).fill(0))}e.zero=a;function h(n){const o=a(n);for(let s=0;s<n;s++)o[s][s]=1;return o}e.id=h;function i(n,o){o?.deg&&(n=n.map(P));const[s,u,m]=n.map(Math.sin),[v,x,E]=n.map(Math.cos),F=[[v,-s,0],[s,v,0],[0,0,1]],H=[[x,0,u],[0,1,0],[-u,0,x]],z=[[1,0,0],[0,E,-m],[0,m,E]];return A(z,A(H,F))}e.rot=i;function f(n,o){return n.map(s=>s[o])}e.colAt=f;function b(n,o){return n.map((s,u)=>d.vAdd(s,o[u]))}e.mAdd=b;function $(n,o){return n.map((s,u)=>d.vSub(s,o[u]))}e.mSub=$;function A(n,o){const s=a(n.length);for(let u=0;u<n.length;u++)for(let m=0;m<o.length;m++)s[u][m]=d.dot(n[u],f(o,m));return s}e.mMul=A;function y(n,o){return n.map(s=>d.add(s,o))}e.add=y;function C(n,o){return y(n,-o)}e.sub=C;function T(n,o){return n.map(s=>d.mul(s,o))}e.mul=T;function M(n,o){return T(n,1/o)}e.div=M;function N(n,o=[0,0,0],s=[0,0,0,1]){return n.map((u,m)=>u.concat(o[m])).concat([s])}e.homo=N;function c(n,o){return n.map(s=>d.dot(s,o))}e.transform=c;function l(n,o){return d.unhomo(c(n,d.homo(o)))}e.transformHomo=l})(p||(p={}));class q{constructor(r=[0,0,0],a=[0,0,0],h=Math.PI/2){this.pos=r,this.rot=a,this.fov=h}setRot(r){this.rot=r.map(P)}setAxisRot(r,a){this.rot[r]=P(a)}setFOV(r){this.fov=P(r)}}class Y{constructor(r=new q){this.cam=r}trigs=[];objs=[];putTri(r){return this.trigs.push(r)-1}putObj(r){return this.objs.push(r)-1}rmTri(r){this.trigs[r]=null}rmObj(r){this.objs[r]=null}render(r,a){this.trigs=this.trigs.filter(o=>o),this.objs=this.objs.filter(o=>o);const h=r.canvas,i=r.context,f=h.width,b=h.height,$=this.cam,A=p.rot($.rot),y=p.homo(A,p.transform(A,d.mul($.pos,-1))),C=2*Math.tan(.5*$.fov)/b,T=[[1,0,0,0],[0,1,0,0],[0,0,0,-1],[0,0,C,0]],M=p.mMul(T,y),N=this.objs.flatMap(o=>o.getTrigs()),c=[];for(const o of this.trigs.concat(N)){const s=o.vertices.map(m=>p.transformHomo(M,m)),u=Math.min(...s.map(m=>m[2]));u<0||c.push({projected:s,z:u,fill:o.fill})}i.clearRect(0,0,f,b);const l=Math.round(.5*f),n=Math.round(.5*b);for(const o of c.sort(({z:s},{z:u})=>s-u)){let[[s,u],[m,v],[x,E]]=o.projected;if(a?.round&&([s,m,x,u,v,E]=[s,m,x,u,v,E].map(Math.round)),i.beginPath(),i.moveTo(l+s,n-u),i.lineTo(l+m,n-v),i.lineTo(l+x,n-E),a?.wireframe){i.lineTo(l+s,n-u),i.stroke();continue}i.fillStyle=o.fill,i.fill()}}}class g{constructor(r,a="green"){this.vertices=r,this.fill=a}}class k{constructor(r,a=[0,0,0],h=[0,0,0],i=p.id(4)){this.trigs=r,this.offset=a,this.origin=h,this.transform=i}setTransform(r){this.transform=r.length===3?p.homo(r):r}getTrigs(){return this.trigs.map(r=>new g(r.vertices.map(a=>{const h=d.vSub(a,this.origin),i=p.transformHomo(this.transform,h);return d.vAdd(d.vAdd(i,this.origin),this.offset)}),r.fill))}}const J=!1,W=!0,X=!0,K=!1,G=1.5,Q=1,I=75,Z=.95,_=1,V=30,L=15,w=1,S=document.getElementById("canvas3d");S.width=window.innerWidth;S.height=window.innerHeight;const tt=new U(S,{noAlpha:J,desync:W}),j=new Y,nt=()=>{j.render(tt,{wireframe:X,round:K})},t=S.width*_,ot=[new g([[0,0,t],[t,0,t],[0,t,t]],`rgba(255,0,0,${w})`),new g([[0,t,t],[t,0,t],[t,t,t]],`rgba(255,0,0,${w})`),new g([[0,0,0],[t,0,0],[t,t,0]],`rgba(0,255,0,${w})`),new g([[0,0,0],[0,t,0],[t,t,0]],`rgba(0,255,0,${w})`),new g([[0,0,0],[t,0,0],[t,0,t]],`rgba(0,0,255,${w})`),new g([[0,0,0],[0,0,t],[t,0,t]],`rgba(0,0,255,${w})`),new g([[0,t,0],[t,t,0],[0,t,t]],`rgba(0,0,0,${w})`),new g([[t,t,0],[0,t,t],[t,t,t]],`rgba(0,0,0,${w})`),new g([[0,t,0],[0,0,0],[0,0,t]],`rgba(255,255,0,${w})`),new g([[0,t,0],[0,t,t],[0,0,t]],`rgba(255,255,0,${w})`),new g([[t,0,0],[t,t,0],[t,t,t]],`rgba(0,255,255,${w})`),new g([[t,0,0],[t,0,t],[t,t,t]],`rgba(0,255,255,${w})`)],O=[];for(let e=0;e<V;e++)O.push(new k(ot,[(Math.random()-.5)*L*t,(Math.random()-.5)*L*t,(Math.random()-.5)*L*t],[t/2,t/2,t/2]));for(const e of O)j.putObj(e);S.onmousemove=e=>{j.cam.setAxisRot(1,(e.offsetX/S.width-.5)*360*G),j.cam.setAxisRot(2,Math.min((e.offsetY/S.height-.5)*85*Q,85))};S.onkeydown=e=>{const r=e.key.toLowerCase(),a=[0,0,0];switch(r){case"w":a[2]=-75;break;case"s":a[2]=I;break;case"d":a[0]=-75;break;case"a":a[0]=I;break}const h=p.transform(p.rot(j.cam.rot),a),i=f=>{d.norm(f)<1||(j.cam.pos=d.vAdd(j.cam.pos,f),requestAnimationFrame(()=>i(d.mul(f,Z))))};i(h)};const rt=[...Array(O.length)].map(()=>(Math.random()+1)*10),et=[...Array(O.length)].map(()=>Math.random()),st=[...Array(O.length)].map(()=>Math.random()),B=e=>{for(let r=0;r<O.length;r++){const a=e/rt[r];O[r].setTransform(p.rot([a*et[r],a*st[r],0],{deg:!0}))}requestAnimationFrame(B)};B(0);let R=0;setInterval(()=>{console.clear(),console.log("fps",R),R=0},1e3);const D=()=>{nt(),R++,requestAnimationFrame(D)};D();
