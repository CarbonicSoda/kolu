(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))h(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const b of l.addedNodes)b.tagName==="LINK"&&b.rel==="modulepreload"&&h(b)}).observe(document,{childList:!0,subtree:!0});function a(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerPolicy&&(l.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?l.credentials="include":i.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function h(i){if(i.ep)return;i.ep=!0;const l=a(i);fetch(i.href,l)}})();const L=e=>Math.PI*e/180;class U{constructor(r=[0,0,0],a=[0,0,0],h=Math.PI/2){this.pos=r,this.rot=a,this.fov=h}setRot(r){this.rot=r.map(L)}setAxisRot(r,a){this.rot[r]=L(a)}setFOV(r){this.fov=L(r)}}class q{canvas;alpha;desync;context;constructor(r,a){this.canvas=r??document.createElement("canvas"),this.alpha=!a?.noAlpha,this.desync=!!a?.desync,this.context=this.canvas.getContext("2d",{alpha:this.alpha,desynchronized:this.desync})}}var d;(e=>{function r(c,f){console.log(`${f??""}${f?" ~ ":""}vec(${c.length}) ${JSON.stringify(c)}`)}e.log=r;function a(c,f){return c.map((n,o)=>n+f[o])}e.vAdd=a;function h(c,f){return c.map((n,o)=>n-f[o])}e.vSub=h;function i(c,f){let n=0;for(let o=0;o<c.length;o++)n+=c[o]*f[o];return n}e.dot=i;function l(c,f){const[n,o,s]=c,[u,m,A]=f;return[o*A-s*m,s*u-n*A,n*m-o*u]}e.cross=l;function b(c,f){return c.map(n=>n+f)}e.add=b;function S(c,f){return b(c,-f)}e.sub=S;function w(c,f){return c.map(n=>n*f)}e.mul=w;function y(c,f){return w(c,1/f)}e.div=y;function O(c){return i(c,c)**.5}e.norm=O;function C(c){return y(c,O(c))}e.unit=C;function M(c){return c.concat(1)}e.homo=M;function N(c){return y(c.slice(0,-1),c.at(-1))}e.unhomo=N})(d||(d={}));var p;(e=>{function r(n,o){console.log(`${o??""}${o?" ~ ":""}mat(${n.length}x${n.length})
[${n.map(s=>JSON.stringify(s)).join(`
 `)}]`)}e.log=r;function a(n){return[...Array(n)].map(()=>Array(n).fill(0))}e.zero=a;function h(n){const o=a(n);for(let s=0;s<n;s++)o[s][s]=1;return o}e.id=h;function i(n,o){o?.deg&&(n=n.map(L));const[s,u,m]=n.map(Math.sin),[A,E,x]=n.map(Math.cos),H=[[A,-s,0],[s,A,0],[0,0,1]],z=[[E,0,u],[0,1,0],[-u,0,E]],D=[[1,0,0],[0,x,-m],[0,m,x]];return w(D,w(z,H))}e.rot=i;function l(n,o){return n.map(s=>s[o])}e.colAt=l;function b(n,o){return n.map((s,u)=>d.vAdd(s,o[u]))}e.mAdd=b;function S(n,o){return n.map((s,u)=>d.vSub(s,o[u]))}e.mSub=S;function w(n,o){const s=a(n.length);for(let u=0;u<n.length;u++)for(let m=0;m<o.length;m++)s[u][m]=d.dot(n[u],l(o,m));return s}e.mMul=w;function y(n,o){return n.map(s=>d.add(s,o))}e.add=y;function O(n,o){return y(n,-o)}e.sub=O;function C(n,o){return n.map(s=>d.mul(s,o))}e.mul=C;function M(n,o){return C(n,1/o)}e.div=M;function N(n,o=[0,0,0],s=[0,0,0,1]){return n.map((u,m)=>u.concat(o[m])).concat([s])}e.homo=N;function c(n,o){return n.map(s=>d.dot(s,o))}e.transform=c;function f(n,o){return d.unhomo(c(n,d.homo(o)))}e.transformHomo=f})(p||(p={}));class Y{constructor(r=new U){this.cam=r}trigs=[];objs=[];putTri(r){return this.trigs.push(r)-1}putObj(r){return this.objs.push(r)-1}rmTri(r){this.trigs[r]=null}rmObj(r){this.objs[r]=null}render(r,a){this.trigs=this.trigs.filter(o=>o),this.objs=this.objs.filter(o=>o);const h=r.canvas,i=r.context,l=h.width,b=h.height,S=this.cam,w=p.rot(S.rot),y=p.homo(w,p.transform(w,d.mul(S.pos,-1))),O=2*Math.tan(.5*S.fov)/b,C=[[1,0,0,0],[0,1,0,0],[0,0,0,-1],[0,0,O,0]],M=p.mMul(C,y),N=this.objs.flatMap(o=>o.getTrigs()),c=[];for(const o of this.trigs.concat(N)){const s=o.vertices.map(m=>p.transformHomo(M,m)),u=Math.min(...s.map(m=>m[2]));u<0||c.push({projected:s,z:u,fill:o.fill})}i.clearRect(0,0,l,b);const f=Math.round(.5*l),n=Math.round(.5*b);for(const o of c.sort(({z:s},{z:u})=>s-u)){let[[s,u],[m,A],[E,x]]=o.projected;if(a?.round&&([s,m,E,u,A,x]=[s,m,E,u,A,x].map(Math.round)),i.beginPath(),i.moveTo(f+s,n-u),i.lineTo(f+m,n-A),i.lineTo(f+E,n-x),a?.wireframe){i.lineTo(f+s,n-u),i.stroke();continue}i.fillStyle=o.fill,i.fill()}}}class g{constructor(r,a="green"){this.vertices=r,this.fill=a}}class k{constructor(r,a=[0,0,0],h=[0,0,0],i=p.id(4)){this.trigs=r,this.offset=a,this.origin=h,this.transform=i}setTransform(r){this.transform=r.length===3?p.homo(r):r}getTrigs(){return this.trigs.map(r=>new g(r.vertices.map(a=>{const h=d.vSub(a,this.origin),i=p.transformHomo(this.transform,h);return d.vAdd(d.vAdd(i,this.origin),this.offset)}),r.fill))}}const J=!1,W=!0,X=!0,K=!1,_=3,G=1.5,P=75,Q=.95,Z=.3,V=50,R=15,v=1,$=document.getElementById("canvas3d");$.width=window.innerWidth;$.height=window.innerHeight;const tt=new q($,{noAlpha:J,desync:W}),j=new Y,nt=()=>j.render(tt,{wireframe:X,round:K}),t=$.width*Z,ot=[new g([[0,0,t],[t,0,t],[0,t,t]],`rgba(255,0,0,${v})`),new g([[0,t,t],[t,0,t],[t,t,t]],`rgba(255,0,0,${v})`),new g([[0,0,0],[t,0,0],[t,t,0]],`rgba(0,255,0,${v})`),new g([[0,0,0],[0,t,0],[t,t,0]],`rgba(0,255,0,${v})`),new g([[0,0,0],[t,0,0],[t,0,t]],`rgba(0,0,255,${v})`),new g([[0,0,0],[0,0,t],[t,0,t]],`rgba(0,0,255,${v})`),new g([[0,t,0],[t,t,0],[0,t,t]],`rgba(0,0,0,${v})`),new g([[t,t,0],[0,t,t],[t,t,t]],`rgba(0,0,0,${v})`),new g([[0,t,0],[0,0,0],[0,0,t]],`rgba(255,255,0,${v})`),new g([[0,t,0],[0,t,t],[0,0,t]],`rgba(255,255,0,${v})`),new g([[t,0,0],[t,t,0],[t,t,t]],`rgba(0,255,255,${v})`),new g([[t,0,0],[t,0,t],[t,t,t]],`rgba(0,255,255,${v})`)],T=[];for(let e=0;e<V;e++)T.push(new k(ot,[(Math.random()-.5)*R*t,(Math.random()-.5)*R*t,(Math.random()-.5)*R*t],[t/2,t/2,t/2]));for(const e of T)j.putObj(e);$.onmousemove=e=>{j.cam.setAxisRot(1,(e.offsetX/$.width-.5)*180*_),j.cam.setAxisRot(2,(e.offsetY/$.height-.5)*180*G)};$.onkeydown=e=>{const r=e.key.toLowerCase(),a=[0,0,0];switch(r){case"w":a[2]=-P;break;case"s":a[2]=P;break;case"d":a[0]=-P;break;case"a":a[0]=P;break}const h=p.transform(p.rot(j.cam.rot),a),i=l=>{d.norm(l)<1||(j.cam.pos=d.vAdd(j.cam.pos,l),requestAnimationFrame(()=>i(d.mul(l,Q))))};i(h)};const rt=[...Array(T.length)].map(()=>(Math.random()+1)*10),et=[...Array(T.length)].map(()=>Math.random()),st=[...Array(T.length)].map(()=>Math.random()),B=e=>{for(let r=0;r<T.length;r++){const a=e/rt[r];T[r].setTransform(p.rot([a*et[r],a*st[r],0],{deg:!0}))}requestAnimationFrame(B)};B();let I=0;const F=()=>{nt(),I++,requestAnimationFrame(F)};setInterval(()=>{console.clear(),console.log("fps",I),I=0},1e3);F();
